{% extends 'v2/base.html' %}

{% block title %}{{ media[1] if media else 'Media' }} - Alt{% endblock %}

{% block content %}
{% if media %}
<div class="p-6 rounded shadow card-alt">
  <h2 class="text-xl font-semibold mb-2">{{ media[1] }}</h2>
  <div class="text-sm mb-4">by <a href="{{ url_for('creator_profile', user_id=creator_id) }}" class="underline">{{ media[4] }}</a></div>
  {% if media[3] %}
    <div class="mb-4">
      {% if media[3].lower().endswith('.mp4') %}
        <video class="w-full" controls>
          <source src="{{ url_for('uploads', filename=media[3]) }}" type="video/mp4">
        </video>
      {% else %}
        <img src="{{ url_for('uploads', filename=media[3]) }}" alt="media" class="w-full rounded">
      {% endif %}
    </div>
  {% endif %}
  <p class="mb-4 text-gray-200">{{ media[2] }}</p>

    <div class="mb-4">
  {% if session.get('logged_in') and session.get('role') == 'Consumer' %}
  <div class="flex flex-2 items-center gap-4">
      <form method="post" class="flex gap-2">
        <input type="hidden" name="action" value="react">
        <button name="reaction" value="heart" title="Love" class="text-2xl">‚ù§Ô∏è {% if reactions_map and reactions_map.get('heart') %} <span class="text-sm">{{ reactions_map.get('heart') }}</span>{% endif %}</button>
        <button name="reaction" value="laugh" title="Haha" class="text-2xl">üòÇ {% if reactions_map and reactions_map.get('laugh') %} <span class="text-sm">{{ reactions_map.get('laugh') }}</span>{% endif %}</button>
        <button name="reaction" value="wow" title="Wow" class="text-2xl">üòÆ {% if reactions_map and reactions_map.get('wow') %} <span class="text-sm">{{ reactions_map.get('wow') }}</span>{% endif %}</button>
      </form>

      <!-- Professional numeric rating for v2: slider 1-10 -->
      <form method="post" class="flex items-center gap-4">
        <input type="hidden" name="action" value="rate">
        <div class="flex items-center gap-2">
          <input id="rating-range" type="range" name="rating" min="1" max="10" value="5" oninput="document.getElementById('rating-value').textContent=this.value" />
          <div class="text-sm text-gray-200">Score: <span id="rating-value">5</span></div>
        </div>
        <button class="bg-teal-500 text-white px-3 py-1 rounded">Rate</button>
      </form>

      {% if rating_avg %}
        <div class="ml-4 text-sm text-gray-300">Average rating: <strong>{{ rating_avg }}</strong></div>
      {% else %}
        <div class="ml-4 text-sm text-gray-300">No ratings yet</div>
      {% endif %}
    </div>
    {% elif session.get('logged_in') and session.get('role') == 'creator' %}
  <div class="text-sm text-gray-300">Post view only for creators.</div>
    {% else %}
  <div class="text-sm text-gray-300">Login to comment, react or rate.</div>
    {% endif %}
  </div>

  {% if session.get('logged_in') and session.get('role') == 'Consumer' %}
  <div class="mb-4">
    <form method="post" class="space-y-2">
      <input type="hidden" name="action" value="comment">
      <textarea name="comment" class="w-full border rounded px-3 py-2 bg-gray-900 text-gray-100" placeholder="Write a comment"></textarea>
      <div class="flex justify-end">
        <button class="bg-gray-800 text-white px-3 py-1 rounded">Comment</button>
      </div>
      <div class="mt-3">
        <button id="share-this" class="bg-gray-700 text-white px-3 py-1 rounded" data-media-id="{{ media[0] }}" data-media-url="{{ url_for('media_detail', media_id=media[0], _external=True) }}">Share</button>
      </div>
    </form>
  </div>
  {% endif %}

  <div>
    <h3 class="font-medium text-gray-100">Comments</h3>
    <div class="text-sm text-gray-400 mt-1">{{ comments|length }} comments</div>
    <ul class="space-y-2 mt-2">
      {% for c in comments %}
        <li class="border rounded p-2 bg-gray-900">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-semibold text-teal-300">{{ c.user }}</div>
              <div class="text-sm text-gray-200">{{ c.text }}</div>
              <div class="text-xs text-gray-400">{{ c.created_at }}</div>
            </div>
            <div class="text-xs text-gray-300">Likes: {{ c.likes }}</div>
          </div>
          <form method="post" class="mt-2 flex gap-2">
            <input type="hidden" name="action" value="comment_reply">
            <input type="hidden" name="parent_id" value="{{ c.id }}">
            <input name="comment" placeholder="Reply..." class="flex-1 rounded px-3 py-2 text-sm bg-gray-800 text-gray-100 border border-gray-700">
            <button class="bg-teal-600 text-white px-3 py-1 rounded">Reply</button>
          </form>
          {% if c.replies and c.replies|length %}
            <ul class="mt-2 ml-6 space-y-2">
              {% for r in c.replies %}
                <li class="border rounded p-2 bg-gray-800">
                  <div class="text-sm font-semibold text-teal-200">{{ r.user }}</div>
                  <div class="text-sm text-gray-200">{{ r.text }}</div>
                  <div class="text-xs text-gray-400">{{ r.created_at }}</div>
                  <div class="text-xs text-gray-300">Likes: {{ r.likes }}</div>
                </li>
              {% endfor %}
            </ul>
          {% endif %}
        </li>
      {% else %}
        <li class="text-sm text-gray-400">No comments yet</li>
      {% endfor %}
    </ul>
  </div>
</div>
{% else %}
<div class="bg-gray-800 p-6 rounded shadow">Media not found</div>
{% endif %}
{% endblock %}
